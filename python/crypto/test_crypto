# crypto test cases
# pip install pycryptodome
import os
import json
from Crypto.Cipher import DES3
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad
from Crypto.Util.Padding import unpad

config_dir = 'crypto/'
config_file = 'test_crypto.json'

#-------------------------------------------------------------
# do_aes
#-------------------------------------------------------------
def do_AES(operation, key_value, mode, data, iv):
    key_bin = bytes.fromhex(key_value)
    if (mode == "ECB"):
        cipher_obj= AES.new(key_bin, AES.MODE_ECB)
    if (mode == "CBC"):
        iv_bin = bytes.fromhex(iv)
        cipher_obj= AES.new(key_bin, AES.MODE_CBC, iv=iv_bin)

    data_bin = bytes.fromhex(data)

    if (operation == "encrypt"):
        return cipher_obj.encrypt(data_bin).hex()
    else:
        return unpad(cipher_obj.decrypt(data_bin), len(key_bin)).hex() 

#-------------------------------------------------------------
# do_DES
#-------------------------------------------------------------
def do_DES(operation, key_value, mode, data, iv):
    if len(key_value) == 32 :
       key_value = key_value + key_value[0: 16]  # double des set k3 = K1 
    if len(key_value) == 16:
       key_value = key_value + key_value + key_value  # single des set k2=k1, k3=k1

    key_bin = bytes.fromhex(key_value)
    key_token = DES3.adjust_key_parity(key_bin)

    if (mode == "ECB"):
       cipher_obj = DES3.new(key_token, DES3.MODE_ECB)
    if (mode == "CBC"):
        cipher_obj = DES3.new(key_token, DES3.MODE_CBC)

    data_bin = bytes.fromhex(data)
    if (operation == "encrypt"):
        return cipher_obj.encrypt(data_bin).hex()
    else:
        return cipher_obj.decrypt(data_bin).hex()

#---------------------------------------------------------------------
# hex_string_xor(s1, s2)
# https://stackoverflow.com/questions/52851023/python-3-xor-bytearrays
#---------------------------------------------------------------------
def hex_string_xor(s1, s2):
    one = bytes.fromhex(s1)
    two = bytes.fromhex(s2)
    one_xor_two = bytes(a ^ b for (a, b) in zip(one, two))
    return one_xor_two.hex()

#-------------------------------------------
# run_test: Run a crypto test case
#-------------------------------------------
def run_test(crypto_keys, test_case):
    description = test_case['description']
    alg =  test_case['alg']
    expected_result = test_case["expected_result"].lower()
    result_hex = ""

    if (alg == 'DES' or alg == 'AES'):
        key_name = test_case["key_name"]
        key_value = crypto_keys[key_name]
        if (alg == 'DES'):
            result_hex = do_DES(test_case['operation'], key_value, test_case['mode'], 
                                        test_case['data'], test_case['IV'])
        if (alg == 'AES'): 
            result_hex = do_AES(test_case['operation'], key_value, test_case['mode'], 
                                        test_case['data'], test_case['IV'])
    if (alg == "XOR"):
        result_hex = hex_string_xor(test_case["s1"], test_case["s2"]) 

    if (result_hex == expected_result):
       result = "Success"
    else:
        result = "Fail"
    print("test:" + description + " result:" + result + " result_hex:" + result_hex + " expected:" + expected_result)
#-----------------------------------------------------------------------------------------
# load config ... load the test_rest.json who has the test cases and connection details.
#-----------------------------------------------------------------------------------------
def load_config():
    with open(config_dir +  config_file, 'r') as file:
        json_data = file.read()
        return json.loads(json_data)
#-----------------------------------------------------------------------------------------
# run_tests:  Run all tests in the config['tests'l
#-----------------------------------------------------------------------------------------
def run_tests(config):
    crypto_keys = config['crypto_keys']
    for key in config['tests']:
        test_case_name= str(key)
        test_case = config['tests'][test_case_name]
        run_test(crypto_keys, test_case)
    
# here we go
print('current directory:' + os.getcwd())
config = load_config()
run_tests(config)